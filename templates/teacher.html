{% extends "base.html" %}
{% block content %}

<!-- ================= èƒŒæ™¯å±‚ ================= -->
<div class="fixed inset-0 -z-10 bg-[#0B1120] overflow-hidden">
    <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-5 mix-blend-overlay"></div>
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_top_right,_var(--tw-gradient-stops))] from-[#1e293b] via-[#0f172a] to-[#020617] opacity-90"></div>
    <div class="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:50px_50px] [mask-image:radial-gradient(ellipse_at_center,black_50%,transparent_100%)]"></div>
</div>

<div class="flex h-screen w-full overflow-hidden text-slate-200 font-sans selection:bg-cyan-500/30">

    <!-- ================= å·¦ä¾§å¯¼èˆªæ  ================= -->
    <aside class="w-64 flex-col bg-[#0f172a]/80 border-r border-slate-800/60 backdrop-blur-2xl z-30 hidden md:flex">
        <div class="h-24 flex items-center gap-4 px-6 border-b border-slate-800/50">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-cyan-500 flex items-center justify-center shadow-lg shadow-blue-500/20 text-white font-black text-xl">C</div>
            <div>
                <h1 class="font-bold text-white text-lg tracking-tight">ClassSync</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Admin Pro</p>
            </div>
        </div>
        <nav class="flex-1 p-6 space-y-3">
            <div class="text-[10px] font-black text-slate-600 uppercase tracking-widest mb-4">Dashboard</div>
            <button class="w-full flex items-center gap-4 px-4 py-3.5 rounded-xl bg-blue-600/10 text-blue-400 border border-blue-600/20 font-bold transition shadow-sm">
                <span class="text-lg">ğŸ®</span> æ§åˆ¶å°
            </button>
            <button onclick="openDataCenter()" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-xl hover:bg-slate-800/50 text-slate-400 hover:text-white transition group border border-transparent hover:border-slate-700">
                <span class="text-lg group-hover:scale-110 transition-transform duration-300">ğŸ“Š</span> æ•°æ®ä¸­å¿ƒ
            </button>
        </nav>
        <div class="p-6 border-t border-slate-800/50">
            <a href="/logout" class="flex items-center justify-center gap-2 w-full py-3 rounded-xl border border-slate-800 hover:bg-slate-800 text-slate-500 hover:text-white text-sm font-bold transition">
                <span>ğŸšª</span> é€€å‡ºç³»ç»Ÿ
            </a>
        </div>
    </aside>

    <!-- ================= å³ä¾§ä¸»åŒºåŸŸ ================= -->
    <main class="flex-1 flex flex-col relative z-10 min-w-0 bg-gradient-to-b from-transparent to-[#020617]/50">
        
        <!-- 1. é¡¶éƒ¨æŒ‡æŒ¥èˆ± -->
        <header class="h-24 px-8 flex items-center justify-between border-b border-slate-800/50 bg-[#0f172a]/40 backdrop-blur-sm z-20">
            <div class="flex-1 max-w-5xl flex items-center gap-4 mr-10">
                <div class="flex-1 flex h-14 bg-slate-900/60 rounded-2xl border border-slate-700/50 overflow-hidden shadow-lg focus-within:border-blue-500/50 focus-within:ring-4 focus-within:ring-blue-500/10 transition-all">
                    <div class="w-14 flex items-center justify-center text-slate-500 border-r border-slate-700/50 text-xl">âœï¸</div>
                    <input id="q_content" type="text" placeholder="è¾“å…¥æœ¬è½®äº’åŠ¨é¢˜ç›®..." 
                           class="flex-1 bg-transparent px-5 text-white placeholder-slate-600 outline-none font-bold text-lg">
                    <div class="relative border-l border-slate-700/50 bg-slate-800/20 w-32 hover:bg-slate-800/40 transition">
                        <select id="q_type" onchange="toggleOptionInput()" class="w-full h-full pl-4 pr-8 bg-transparent text-sm font-bold text-slate-300 outline-none cursor-pointer hover:text-white appearance-none">
                            <option value="choice">å•é€‰é¢˜</option>
                            <option value="sort">æ’åºé¢˜</option>
                        </select>
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-500 pointer-events-none">â–¼</span>
                    </div>
                </div>
                <div id="option_wrapper" class="w-56 transition-all duration-500 ease-out overflow-hidden h-14">
                    <input id="q_options" type="text" value="A,B,C,D" 
                           class="w-full h-full px-5 rounded-2xl bg-slate-900/60 border border-slate-700/50 outline-none text-slate-300 font-bold focus:border-blue-500/50 transition placeholder-slate-600 text-center tracking-widest" 
                           placeholder="é€‰é¡¹è®¾ç½®">
                </div>
                <button id="btn_pub" onclick="sendQuestion()" 
                        class="h-14 px-8 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-black text-lg shadow-xl shadow-blue-900/30 transition transform active:scale-95 flex items-center gap-2">
                    ğŸš€ å‘å¸ƒ
                </button>
                <button id="btn_stop" onclick="showGradeModal()" 
                        class="hidden h-14 px-8 rounded-2xl bg-gradient-to-r from-rose-600 to-pink-600 hover:from-rose-500 hover:to-pink-500 text-white font-black text-lg shadow-xl shadow-rose-900/30 transition transform active:scale-95 flex items-center gap-2">
                    ğŸ›‘ ç»“ç®—
                </button>
            </div>
            <div class="flex items-center gap-4">
                <button id="privacy_btn" onclick="togglePrivacy()" 
                        class="h-10 px-4 rounded-xl bg-slate-800/50 border border-slate-700 text-slate-400 hover:text-white hover:border-slate-500 transition text-xs font-bold flex items-center gap-2">
                    <span id="privacy_icon">ğŸ‘ï¸</span> <span id="privacy_text">ç­”æ¡ˆå¯è§</span>
                </button>
            </div>
        </header>

        <!-- 2. ä¸­å¤®ç›‘è§†å™¨ -->
        <div class="flex-1 p-6 overflow-hidden flex flex-col">
            <div class="flex-1 bg-black/20 border border-slate-700/30 rounded-3xl relative overflow-hidden flex flex-col shadow-2xl backdrop-blur-sm">
                
                <div class="h-12 border-b border-slate-800/50 bg-[#0f172a]/40 flex items-center justify-between px-6 select-none relative z-30">
                    <div class="flex gap-2">
                        <div class="w-3 h-3 rounded-full bg-red-500/20 border border-red-500/50"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-500/20 border border-yellow-500/50"></div>
                        <div class="w-3 h-3 rounded-full bg-green-500/20 border border-green-500/50"></div>
                    </div>
                    <div class="text-[10px] font-black text-slate-600 tracking-[0.2em] flex gap-6">
                        <span id="response_count" class="text-blue-400">0 SUBMISSIONS</span>
                        <span>LIVE FEED</span>
                    </div>
                </div>

                <div class="relative flex-1 overflow-hidden">
                    <div id="waiting_hint" class="absolute inset-0 flex flex-col items-center justify-center text-slate-800 select-none pointer-events-none transition-all duration-700">
                        <div class="text-8xl font-black tracking-tighter opacity-30">READY</div>
                        <div class="text-sm font-bold tracking-[1em] mt-4 opacity-30 text-blue-500 uppercase">System Standby</div>
                    </div>

                    <!-- å¼¹å¹•å±‚ -->
                    <div id="danmaku_container" class="absolute inset-0 overflow-y-auto p-8 scroll-smooth z-10 transition-all duration-700 custom-scrollbar">
                        <div id="danmaku_stage" class="flex flex-wrap content-start gap-3 min-h-full pb-32 pr-20"></div>
                    </div>

                    <!-- ç»“æœå±•ç¤ºå±‚ -->
                    <div id="result_container" class="absolute inset-0 z-50 bg-[#0f172a]/95 backdrop-blur-xl flex flex-col border-t border-blue-500/30 shadow-[0_-20px_50px_rgba(0,0,0,0.8)]" style="visibility: hidden; opacity: 0; transform: translateY(100%);">
                        <div class="h-16 border-b border-slate-800 flex items-center justify-center relative bg-[#0f172a]">
                            <span class="text-sm font-black text-blue-400 uppercase tracking-[0.3em]">Analysis Result</span>
                            <button onclick="closeResultPanel()" class="absolute right-6 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white transition text-xl bg-slate-800/50 w-8 h-8 rounded-full flex items-center justify-center">âœ•</button>
                        </div>
                        <div id="result_stage" class="flex-1 overflow-x-auto flex items-end justify-center gap-10 p-10 pb-16 custom-scrollbar">
                            <!-- JS ç”Ÿæˆæ–¹å— -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ================= æ¨¡æ€æ¡†åŒº ================= -->

    <!-- 1. ç»“ç®—ç¡®è®¤çª— -->
    <div id="grade_modal" class="fixed inset-0 bg-[#020617]/80 backdrop-blur-md z-50 hidden flex items-center justify-center opacity-0">
        <div id="modal_box" class="bg-[#1e293b] border border-slate-700 p-8 rounded-3xl w-[480px] shadow-2xl transform scale-95 flex flex-col">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                    <span class="text-3xl">ğŸ”</span> é”å®šç­”æ¡ˆ
                </h3>
                <button onclick="addAnswerInput()" class="text-xs font-bold bg-slate-800 text-blue-400 border border-slate-700 px-4 py-2 rounded-lg hover:bg-blue-600 hover:text-white hover:border-blue-500 transition">+ æ·»åŠ è§£æ³•</button>
            </div>
            <div id="answers_container" class="flex-1 overflow-y-auto space-y-3 mb-8 max-h-[300px] pr-2 custom-scrollbar">
                <div class="flex gap-2">
                    <input type="text" placeholder="æ­£ç¡®ç­”æ¡ˆ (å¦‚ A)" class="ans-input flex-1 h-16 text-center text-3xl font-black bg-black/20 border border-slate-600 rounded-2xl text-white outline-none focus:border-blue-500 transition uppercase placeholder:text-slate-700 placeholder:text-lg">
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="hideGradeModal()" class="flex-1 py-4 rounded-2xl border border-slate-700 text-slate-400 hover:bg-slate-800 font-bold transition">å–æ¶ˆ</button>
                <button onclick="confirmGrade()" class="flex-1 py-4 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold shadow-lg shadow-blue-900/30 transition">ç«‹å³æ­æ™“</button>
            </div>
        </div>
    </div>

    <!-- 2. æ•°æ®ä¸­å¿ƒ -->
    <div id="data_center_modal" class="fixed inset-0 z-[100] hidden">
        <div id="dc_backdrop" class="absolute inset-0 bg-[#020617]/95 backdrop-blur-xl opacity-0"></div>
        <div id="dc_content" class="absolute inset-4 md:inset-12 bg-[#0f172a] rounded-3xl border border-slate-800 shadow-2xl flex flex-col overflow-hidden translate-y-20 opacity-0">
            <div class="h-24 px-8 md:px-12 border-b border-slate-800 flex justify-between items-center bg-[#1e293b]/50">
                <div class="flex items-center gap-6">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-3xl shadow-lg shadow-blue-500/20">ğŸ“Š</div>
                    <div>
                        <h2 class="text-2xl font-bold text-white tracking-tight">æ•°æ®é©¾é©¶èˆ±</h2>
                        <p class="text-slate-400 text-sm mt-1">Class Data Analytics Center</p>
                    </div>
                </div>
                <button onclick="closeDataCenter()" class="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 hover:bg-red-600 hover:text-white transition text-xl font-bold">âœ•</button>
            </div>
            <div class="flex-1 overflow-auto p-8 md:p-12 custom-scrollbar relative">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-[#0f172a] border-b border-slate-700">
                        <tr class="text-slate-400 text-sm font-bold uppercase tracking-wider">
                            <th class="pb-6 pl-6 w-1/4">å­¦ç”Ÿå§“å</th>
                            <th class="pb-6 w-1/6">æœ¬å­£æ´»è·ƒ</th>
                            <th class="pb-6 w-1/6">æœ¬å­£æ­£ç¡®ç‡</th>
                            <th class="pb-6 w-1/6">ç”Ÿæ¶¯æ€»é¢˜</th>
                            <th class="pb-6 text-right pr-6">ç”Ÿæ¶¯æ€»èƒœç‡</th>
                        </tr>
                    </thead>
                    <tbody id="student_data_list" class="text-base font-medium text-slate-300"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ä¸Šå¸æ¨¡å¼ -->
    <div class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 group">
        <div class="w-12 h-12 rounded-full bg-slate-800/80 backdrop-blur border border-slate-600 flex items-center justify-center cursor-pointer hover:bg-slate-700 shadow-xl group-hover:hidden transition text-slate-400 text-xl">âš¡</div>
        <div class="hidden group-hover:flex flex-col bg-[#0f172a] border border-slate-600 p-4 rounded-xl shadow-2xl w-56 animate-fade-in-up">
            <h4 class="text-white font-bold mb-3 border-b border-slate-700 pb-2 text-xs">å‹åŠ›æµ‹è¯•</h4>
            <button onclick="simulate('random')" class="mb-2 w-full py-2 rounded bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold">ğŸ² 60 Bots (Random)</button>
            <button onclick="simulate('stacked')" class="w-full py-2 rounded bg-orange-600 hover:bg-orange-500 text-white text-xs font-bold">ğŸ¢ 50 Bots (Stack)</button>
            <div id="sim_status" class="text-[10px] text-slate-400 mt-2 text-center">Idle</div>
        </div>
    </div>

    <div class="fixed bottom-2 left-2 text-[10px] text-slate-700 pointer-events-none select-none z-50">v3.8 Fast Physics</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script>
    const socket = io();
    let currentQId = null;
    let currentQType = 'choice';
    let hideAnswers = false; 
    let answerCount = 0; 

    const resCont = document.getElementById('result_container');
    gsap.set(resCont, { y: "100%", autoAlpha: 0 });

    function toggleOptionInput() {
        const type = document.getElementById('q_type').value;
        const wrap = document.getElementById('option_wrapper');
        wrap.style.width = type === 'choice' ? '14rem' : '0';
        wrap.style.opacity = type === 'choice' ? '1' : '0';
    }
    function togglePrivacy() {
        hideAnswers = !hideAnswers;
        const btn = document.getElementById('privacy_btn');
        const icon = document.getElementById('privacy_icon');
        const text = document.getElementById('privacy_text');
        if (hideAnswers) {
            btn.classList.add('border-purple-500', 'text-purple-400', 'bg-purple-900/20');
            btn.classList.remove('bg-slate-900', 'text-slate-400');
            icon.innerText = "ğŸ”’"; text.innerText = "å·²éšè—";
        } else {
            btn.classList.remove('border-purple-500', 'text-purple-400', 'bg-purple-900/20');
            btn.classList.add('bg-slate-900', 'text-slate-400');
            icon.innerText = "ğŸ‘ï¸"; text.innerText = "ç­”æ¡ˆå¯è§";
        }
    }

    function setUIState(state) {
        const statusText = document.getElementById('status_text');
        const hint = document.getElementById('waiting_hint');
        const dmCont = document.getElementById('danmaku_container');

        if(state === 'live') {
            if(statusText) { statusText.innerText = "LIVE RECEIVING"; statusText.className = "text-[10px] font-black text-green-500 uppercase tracking-widest animate-pulse"; }
            gsap.to(resCont, { y: "100%", autoAlpha: 0, duration: 0.5, ease: "power2.in" });
            hint.style.opacity = '0';
            dmCont.classList.remove('opacity-20', 'blur-sm');
        } else if (state === 'result') {
            if(statusText) { statusText.innerText = "ANALYSIS MODE"; statusText.className = "text-[10px] font-black text-blue-500 uppercase tracking-widest"; }
            gsap.to(resCont, { y: "0%", autoAlpha: 1, duration: 0.5, ease: "back.out(0.8)" });
            dmCont.classList.add('opacity-20', 'blur-sm');
        }
    }

    function sendQuestion() {
        const content = document.getElementById('q_content').value;
        const type = document.getElementById('q_type').value;
        const options = document.getElementById('q_options').value;
        if(!content) return;
        socket.emit('new_question', { content, type, options });
        document.getElementById('btn_pub').classList.add('hidden'); document.getElementById('btn_stop').classList.remove('hidden');
        document.getElementById('danmaku_stage').innerHTML = ''; document.getElementById('result_stage').innerHTML = '';
        answerCount = 0; document.getElementById('response_count').innerText = "0 SUBMISSIONS";
        setUIState('live'); currentQType = type;
    }
    socket.on('receive_question', (data) => currentQId = data.id);

    const brightGradients = [
        "bg-gradient-to-r from-violet-600 to-indigo-600 border-violet-400",
        "bg-gradient-to-r from-pink-500 to-rose-500 border-pink-400",
        "bg-gradient-to-r from-cyan-500 to-blue-500 border-cyan-400",
        "bg-gradient-to-r from-emerald-500 to-teal-500 border-emerald-400",
        "bg-gradient-to-r from-amber-500 to-orange-600 border-amber-400",
        "bg-gradient-to-r from-fuchsia-600 to-purple-600 border-fuchsia-400",
    ];
    socket.on('receive_danmaku', (data) => {
        const stage = document.getElementById('danmaku_stage');
        answerCount++;
        document.getElementById('response_count').innerText = answerCount + " SUBMISSIONS";
        const el = document.createElement('div');
        const randomStyle = brightGradients[Math.floor(Math.random() * brightGradients.length)];
        el.className = `flex items-center gap-3 px-5 py-3 rounded-xl border ${randomStyle} shadow-lg shrink-0 select-none cursor-default transform hover:scale-105 transition-transform duration-200 z-10`;
        let displayContent = hideAnswers ? "***" : data.content;
        el.innerHTML = `<div class="flex flex-col items-start leading-none"><span class="text-[10px] text-white/80 font-bold uppercase tracking-wider mb-0.5">${data.student}</span><span class="text-white font-black text-xl drop-shadow-md tracking-wide">${displayContent}</span></div>`;
        stage.appendChild(el);
        stage.scrollTop = stage.scrollHeight;
        gsap.from(el, { x: window.innerWidth, opacity: 0, duration: 1.2, ease: "power3.out" });
    });

    function addAnswerInput() {
        const container = document.getElementById('answers_container');
        const div = document.createElement('div');
        div.className = "flex gap-2 animate-fade-in-up";
        div.innerHTML = `<input type="text" placeholder="è§£æ³• (å¦‚ B)" class="ans-input flex-1 h-16 text-center text-3xl font-black bg-black/20 border border-slate-600 rounded-2xl text-white outline-none focus:border-blue-500 transition uppercase placeholder:text-slate-700 placeholder:text-lg"><button onclick="this.parentElement.remove()" class="w-16 h-16 rounded-2xl border border-red-900/50 text-red-500 hover:bg-red-900/20 font-bold text-xl transition">Ã—</button>`;
        container.appendChild(div);
    }
    function showGradeModal() {
        const modal = document.getElementById('grade_modal');
        modal.classList.remove('hidden');
        gsap.to(modal, {opacity: 1, duration: 0.2});
        gsap.fromTo("#modal_box", {scale: 0.95, opacity: 0}, {scale: 1, opacity: 1, duration: 0.3, ease: "back.out"});
        document.getElementById('answers_container').innerHTML = `<div class="flex gap-2"><input type="text" placeholder="æ­£ç¡®ç­”æ¡ˆ (å¦‚ A)" class="ans-input flex-1 h-16 text-center text-3xl font-black bg-black/20 border border-slate-600 rounded-2xl text-white outline-none focus:border-blue-500 transition uppercase placeholder:text-slate-700 placeholder:text-lg"></div>`;
        setTimeout(() => document.querySelector('.ans-input').focus(), 100);
    }
    function hideGradeModal() {
        const modal = document.getElementById('grade_modal');
        gsap.to(modal, {opacity: 0, duration: 0.2, onComplete: () => modal.classList.add('hidden')});
    }
    function confirmGrade() {
        const inputs = document.querySelectorAll('.ans-input');
        let answers = [];
        inputs.forEach(input => { if(input.value.trim()) answers.push(input.value.trim()); });
        if(answers.length === 0) return alert("è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªç­”æ¡ˆ");
        socket.emit('stop_and_grade', { question_id: currentQId, correct_answers: answers });
        hideGradeModal();
        document.getElementById('btn_stop').classList.add('hidden'); document.getElementById('btn_pub').classList.remove('hidden');
        setUIState('result');
    }
    function closeResultPanel() {
        gsap.to(resCont, { y: "100%", autoAlpha: 0, duration: 0.5, ease: "power2.in" });
        const dmCont = document.getElementById('danmaku_container');
        dmCont.classList.remove('opacity-20', 'blur-sm');
    }
    function simulate(mode) {
        if (!currentQId) return alert("è¯·å…ˆå‘å¸ƒé¢˜ç›®ï¼");
        document.getElementById('sim_status').innerText = "Running...";
        socket.emit('simulate_data', { question_id: currentQId, mode: mode });
    }
    socket.on('simulation_done', (data) => document.getElementById('sim_status').innerText = `Done: ${data.count}`);

    function openDataCenter() {
        const modal = document.getElementById('data_center_modal');
        const backdrop = document.getElementById('dc_backdrop');
        const content = document.getElementById('dc_content');
        modal.classList.remove('hidden');
        gsap.to(backdrop, {opacity: 1, duration: 0.4});
        gsap.to(content, {opacity: 1, y: 0, duration: 0.5, ease: "power3.out"});
        socket.emit('get_all_students_stats'); 
    }
    function closeDataCenter() {
        const modal = document.getElementById('data_center_modal');
        const backdrop = document.getElementById('dc_backdrop');
        const content = document.getElementById('dc_content');
        gsap.to(backdrop, {opacity: 0, duration: 0.3});
        gsap.to(content, { opacity: 0, y: 50, duration: 0.3, ease: "power2.in", onComplete: () => modal.classList.add('hidden') });
    }
    
    socket.on('all_students_stats_response', (data) => {
        const tbody = document.getElementById('student_data_list');
        tbody.innerHTML = '';
        data.sort((a, b) => b.curr_rate - a.curr_rate); 
        data.forEach((s, index) => {
            const tr = document.createElement('tr');
            tr.className = "border-b border-slate-800/50 hover:bg-blue-900/10 transition group opacity-0"; 
            let rateColorClass = "text-cyan-400"; let barColorClass = "bg-cyan-600"; let rateBgClass = "bg-cyan-900/30 border-cyan-700/50 text-cyan-300"; let rowClass = ""; let textHighlight = "text-white"; let sparkEffect = "";
            if (s.curr_rate >= 80) {
                rowClass = "bg-amber-500/5 hover:bg-amber-500/10"; textHighlight = "text-amber-200"; rateColorClass = "text-amber-400 drop-shadow-[0_0_8px_rgba(251,191,36,0.6)]"; barColorClass = "bg-gradient-to-r from-amber-400 to-yellow-300 shadow-[0_0_10px_rgba(251,191,36,0.4)]"; rateBgClass = "bg-amber-900/40 border-amber-500/50 text-amber-300 shadow-[0_0_10px_rgba(245,158,11,0.2)]"; sparkEffect = `<div class="absolute inset-0 w-full h-full pointer-events-none overflow-hidden"><div class="sparkle s1"></div><div class="sparkle s2"></div></div>`;
            } else if (s.curr_rate >= 50) {
                rateColorClass = "text-emerald-400"; barColorClass = "bg-emerald-500"; rateBgClass = "bg-emerald-900/30 border-emerald-700 text-emerald-300";
            }
            tr.innerHTML = `<td class="py-5 pl-6 relative">${sparkEffect}<div class="flex items-center gap-4 relative z-10"><div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-sm font-bold border border-slate-700 shadow-inner group-hover:scale-110 transition-transform">${s.username[0].toUpperCase()}</div><span class="text-lg font-bold tracking-wide ${textHighlight}">${s.username}</span></div></td><td class="py-5 font-bold text-slate-400 relative z-10 text-base font-sans">${s.curr_total} æ¬¡</td><td class="py-5 relative z-10"><div class="flex items-center gap-3"><div class="w-24 h-2 rounded-full bg-slate-800 overflow-hidden shadow-inner"><div class="h-full rounded-full ${barColorClass} transition-all duration-1000" style="width: ${s.curr_rate}%"></div></div><span class="${rateColorClass} font-black text-lg font-sans">${s.curr_rate}%</span></div></td><td class="py-5 font-bold text-slate-300 relative z-10 text-base font-sans">${s.all_total}</td><td class="py-5 text-right pr-6 relative z-10"><span class="inline-block px-3 py-1.5 rounded-lg border text-sm font-black font-sans ${rateBgClass}">${s.all_rate}% Win</span></td>`;
            if(rowClass) tr.classList.add(...rowClass.split(' '));
            tbody.appendChild(tr);
            gsap.to(tr, {opacity: 1, x: 0, duration: 0.4, delay: index * 0.05, startAt: {x: -20}});
        });
    });

    // â˜…â˜…â˜… æé€Ÿç‰©ç†åŠ¨ç”»ä¿®å¤ â˜…â˜…â˜…
    socket.on('grading_complete', (data) => {
        const stage = document.getElementById('result_stage');
        stage.innerHTML = '';
        const groups = data.groups;
        const MAX_PER_COL = 12; 

        Object.keys(groups).forEach((key) => {
            const students = groups[key];
            let isTargetGroup = false;
            if (students.length > 0 && students[0].is_correct) isTargetGroup = true;
            if (key === 'CORRECT') isTargetGroup = true;

            const groupWrapper = document.createElement('div');
            groupWrapper.className = "flex flex-col items-center h-full justify-end mx-4"; 
            const colsContainer = document.createElement('div');
            colsContainer.className = "flex gap-2 items-end"; 

            const colCount = Math.ceil(students.length / MAX_PER_COL) || 1;
            
            for (let i = 0; i < colCount; i++) {
                const subCol = document.createElement('div');
                subCol.className = "flex flex-col-reverse gap-1.5 w-32 pb-4"; 
                
                const chunk = students.slice(i * MAX_PER_COL, (i + 1) * MAX_PER_COL);
                chunk.forEach((s, idx) => {
                    const block = document.createElement('div');
                    block.innerText = s.name;
                    
                    let bgClass = "bg-slate-700/50 border-slate-600 text-slate-400";
                    if(s.is_correct) bgClass = "bg-blue-500 border-blue-400 text-white font-bold shadow-[0_0_20px_rgba(59,130,246,0.6)] z-10";
                    if(key === 'WRONG') bgClass = "bg-rose-600/80 border-rose-500 text-white";
                    
                    block.className = `w-full h-10 text-xs flex items-center justify-center rounded-lg border ${bgClass} truncate px-2 select-none transform hover:scale-110 transition`;
                    subCol.appendChild(block);
                    
                    // â˜…â˜…â˜… æé€Ÿæ‰è½ï¼šæ— åˆ—å»¶è¿Ÿï¼Œæå°å—å»¶è¿Ÿ â˜…â˜…â˜…
                    gsap.fromTo(block, 
                        { y: -800, opacity: 0 }, 
                        { y: 0, opacity: 1, duration: 0.6, ease: "bounce.out", delay: idx * 0.02 }
                    );
                });
                colsContainer.appendChild(subCol);
            }
            groupWrapper.appendChild(colsContainer);
            const label = document.createElement('div');
            label.className = `mt-4 font-black text-4xl text-center max-w-[200px] break-words ${isTargetGroup ? 'text-blue-400 drop-shadow-[0_0_15px_rgba(59,130,246,0.6)]' : 'text-slate-600'}`;
            label.innerText = key;
            const totalCount = document.createElement('div');
            totalCount.innerText = students.length;
            totalCount.className = "mb-2 font-bold text-slate-500 text-xl";
            groupWrapper.insertBefore(totalCount, colsContainer);
            groupWrapper.appendChild(label);
            stage.appendChild(groupWrapper);
        });
    });
</script>
<style>
    @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in-up { animation: fade-in-up 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .sparkle { position: absolute; background: white; border-radius: 50%; opacity: 0; animation: sparkle-anim 2s infinite; }
    .s1 { top: 20%; left: 20%; width: 2px; height: 2px; animation-delay: 0s; }
    .s2 { top: 60%; left: 80%; width: 3px; height: 3px; animation-delay: 0.5s; }
    @keyframes sparkle-anim { 0%, 100% { opacity: 0; transform: scale(0); } 50% { opacity: 1; transform: scale(1.5); } }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
</style>
{% endblock %}